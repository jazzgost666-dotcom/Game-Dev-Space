<div id="methodUpload" style="display: none;">
    <label for="gameUpload" class="file-upload-label">SELECIONAR HTML/JS/CSS</label>
    <input type="file" id="gameUpload" accept=".html,.js,.css" multiple onchange="handleSecureUpload(this)">
    <div id="scanStatus" style="font-size: 0.7rem; margin-top: 5px;"></div>
</div>

<script>
    // ... suas vari√°veis iniciais ...
    let safeFileBundle = ""; 

    // FUN√á√ÉO DE SCAN E INTEGRA√á√ÉO DE ARQUIVOS
    async function handleSecureUpload(input) {
        const files = input.files;
        const status = document.getElementById('scanStatus');
        const btn = document.querySelector('button[onclick="saveGame()"]');
        
        status.innerText = "üîç Analisando seguran√ßa...";
        status.style.color = "var(--accent)";
        btn.disabled = true;

        let combinedContent = "";
        
        for (let file of files) {
            const content = await file.text();
            const isSafe = await scanFileSecurity(content);
            
            if (!isSafe) {
                status.innerText = `‚ùå BLOQUEADO: Risco detectado em ${file.name}`;
                status.style.color = "var(--danger)";
                btn.disabled = true;
                return;
            }
            // Se for JS ou CSS, guardamos para validar, mas o bundle foca no HTML principal
            combinedContent += content;
        }

        // Localiza o HTML principal para ser o ponto de entrada
        const mainFile = Array.from(files).find(f => f.name.endsWith('.html'));
        
        if (mainFile) {
            const reader = new FileReader();
            reader.onload = (e) => {
                safeFileBundle = e.target.result;
                status.innerText = "‚úÖ Arquivos verificados e seguros!";
                status.style.color = "#10b981";
                btn.disabled = false;
            };
            reader.readAsDataURL(mainFile);
        } else {
            status.innerText = "‚ùå Selecione ao menos um arquivo .html";
            status.style.color = "var(--danger)";
        }
    }

    // AJUSTE NA FUN√á√ÉO SAVEGAME PARA USAR O BUNDLE
    async function saveGame() {
        if(!currentUser) return alert("LOGUE PRIMEIRO!");
        const title = document.getElementById('postTitle').value;
        const pic = document.getElementById('postPic').value;
        const desc = document.getElementById('postDesc').value;
        let url = "";

        if(postMethod === 'link') {
            url = document.getElementById('postUrl').value;
        } else {
            url = safeFileBundle; // Usa o arquivo escaneado pela IA
        }

        if(!title || !url) return alert("TITULO OU ARQUIVO FALTANDO!");

        await db.collection("games").add({
            title, pic, url, desc, 
            likes: 0, views: 0, likedBy: [],
            author: currentUser.email, 
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        closeModals();
    }

    // SEGURAN√áA NO IFRAME (Sandbox)
    // No seu openGame, certifique-se que o iframe tenha o sandbox ativo:
    function openGame(id) {
        // ... sua l√≥gica de buscar o doc ...
        document.getElementById('gameIframe').setAttribute("sandbox", "allow-scripts allow-same-origin allow-forms");
        document.getElementById('gameIframe').src = g.url;
        // ... resto da fun√ß√£o ...
    }
    
    // O resto do seu c√≥digo (Admin, Auth, Render) continua IGUAL.
</script>
