<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAMEHUB | Engine v2</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        :root { --bg: #070b14; --accent: #8b5cf6; --card: #0f172a; --text: #f8fafc; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); }
        
        header { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 15px 30px; background: rgba(7,11,20,0.9); backdrop-filter: blur(10px);
            position: sticky; top: 0; z-index: 100; border-bottom: 1px solid #1e293b;
        }

        .search-bar { flex-grow: 1; max-width: 400px; margin: 0 20px; }
        .search-bar input { 
            width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #1e293b;
            background: #030712; color: white; outline: none;
        }

        .container { max-width: 1200px; margin: 20px auto; padding: 0 20px; }
        .game-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        
        .card { background: var(--card); border-radius: 10px; overflow: hidden; cursor: pointer; transition: 0.3s; border: 1px solid #1e293b; }
        .card:hover { transform: translateY(-5px); border-color: var(--accent); }
        .card img { width: 100%; height: 150px; object-fit: cover; }
        .card-info { padding: 15px; font-weight: bold; text-transform: uppercase; font-size: 0.9rem; }

        /* Player */
        .player-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 1000; display: none; flex-direction: column; }
        .player-header { padding: 15px; display: flex; justify-content: space-between; background: #0f172a; }
        iframe { flex-grow: 1; border: none; width: 100%; height: 100%; background: #000; }

        /* Modal */
        .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #111827; padding: 25px; border-radius: 10px; z-index: 2001; display: none; width: 90%; max-width: 400px; border: 1px solid var(--accent); }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; display: none; }
        
        .btn { background: var(--accent); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        input, textarea { width: 100%; padding: 10px; margin: 10px 0; background: #030712; border: 1px solid #1e293b; color: white; border-radius: 5px; box-sizing: border-box; }
    </style>
</head>
<body>

    <header>
        <div style="font-weight: 900; color: var(--accent); font-size: 1.5rem;">GAMEHUB</div>
        <div class="search-bar"><input type="text" id="searchInput" placeholder="Pesquisar jogo..."></div>
        <button class="btn" onclick="openModal()">POSTAR</button>
    </header>

    <div class="container">
        <h2 style="color: #64748b; font-size: 0.8rem; letter-spacing: 2px;">TODOS OS JOGOS</h2>
        <div class="game-grid" id="gameGrid"></div>
    </div>

    <div class="player-overlay" id="player">
        <div class="player-header">
            <span id="pTitle" style="font-weight: 900;">JOGO</span>
            <button class="btn" onclick="closePlayer()" style="background: #334155;">SAIR</button>
        </div>
        <iframe id="gameFrame" sandbox="allow-scripts allow-same-origin" allowfullscreen></iframe>
    </div>

    <div class="overlay" id="overlay" onclick="closeModal()"></div>
    <div class="modal" id="modal">
        <h3 style="margin-top:0">NOVO JOGO (.ZIP)</h3>
        <input type="text" id="title" placeholder="Título">
        <input type="text" id="thumb" placeholder="URL da Capa">
        <div style="font-size: 0.7rem; color: #94a3b8; margin-bottom: 5px;">Sobe um arquivo .ZIP com index.html dentro</div>
        <input type="file" id="zipFile" accept=".zip">
        <textarea id="desc" placeholder="Descrição"></textarea>
        <button class="btn" style="width:100%" id="uploadBtn" onclick="uploadGame()">PUBLICAR JOGO</button>
    </div>

    <script>
        // Configuração Firebase (Sua configuração original)
        const firebaseConfig = {
            apiKey: "AIzaSyAMHAKVot044psR421B_t-Ht5EmsueVS8A",
            authDomain: "game-dev-space.firebaseapp.com",
            projectId: "game-dev-space",
            storageBucket: "game-dev-space.firebasestorage.app",
            messagingSenderId: "1073185335190",
            appId: "1:1073185335190:web:ae9ffd88cdf89f53cbdfb7"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let allGames = [];

        // BUSCA JOGOS
        db.collection("games").orderBy("createdAt", "desc").onSnapshot(snap => {
            allGames = [];
            snap.forEach(doc => allGames.push({id: doc.id, ...doc.data()}));
            renderGames(allGames);
        });

        function renderGames(list) {
            const grid = document.getElementById('gameGrid');
            grid.innerHTML = list.map(g => `
                <div class="card" onclick="playGame('${g.id}')">
                    <img src="${g.pic || 'https://placehold.co/400x200/0f172a/8b5cf6?text=Game'}">
                    <div class="card-info">${g.title}</div>
                </div>
            `).join('');
        }

        // CONSERTO DA BARRA DE PESQUISA
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = allGames.filter(g => g.title.toLowerCase().includes(term));
            renderGames(filtered);
        });

        // UPLOAD ZIP
        async function uploadGame() {
            const file = document.getElementById('zipFile').files[0];
            const title = document.getElementById('title').value;
            const pic = document.getElementById('thumb').value;
            const desc = document.getElementById('desc').value;

            if(!file || !title) return alert("Preencha o título e selecione o arquivo .zip");
            
            const btn = document.getElementById('uploadBtn');
            btn.innerText = "PROCESSANDO...";
            btn.disabled = true;

            const reader = new FileReader();
            reader.onload = async (e) => {
                const base64 = e.target.result;
                await db.collection("games").add({
                    title, pic, desc,
                    zipData: base64, // O zip vai como base64 pro Firestore
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                closeModal();
                btn.innerText = "PUBLICAR JOGO";
                btn.disabled = false;
            };
            reader.readAsDataURL(file);
        }

        // RODAR O JOGO DO ZIP
        async function playGame(id) {
            const game = allGames.find(g => g.id === id);
            document.getElementById('pTitle').innerText = game.title;
            
            const zipBase64 = game.zipData.split(',')[1];
            const jszip = new JSZip();
            const zip = await jszip.loadAsync(zipBase64, {base64: true});
            
            // Procura o index.html dentro do zip
            const htmlFile = zip.file(/index\.html/i)[0];
            if(!htmlFile) return alert("Erro: index.html não encontrado no zip!");

            // Gera o Blob do HTML e de todos os arquivos referenciados
            const blobMap = {};
            for (let path in zip.files) {
                const file = zip.files[path];
                if (!file.dir) {
                    const content = await file.async("blob");
                    blobMap[path] = URL.createObjectURL(content);
                }
            }

            // Lê o HTML e troca as referências de arquivos por Blobs locais
            let htmlContent = await htmlFile.async("string");
            for (let path in blobMap) {
                // Esse regex substitui nomes de arquivos no HTML pelos links de memória
                const escapedPath = path.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                htmlContent = htmlContent.replace(new RegExp(escapedPath, 'g'), blobMap[path]);
            }

            const finalBlob = new Blob([htmlContent], {type: 'text/html'});
            document.getElementById('gameFrame').src = URL.createObjectURL(finalBlob);
            document.getElementById('player').style.display = 'flex';
        }

        function closePlayer() {
            document.getElementById('player').style.display = 'none';
            document.getElementById('gameFrame').src = '';
        }

        function openModal() { document.getElementById('modal').style.display = 'block'; document.getElementById('overlay').style.display = 'block'; }
        function closeModal() { document.getElementById('modal').style.display = 'none'; document.getElementById('overlay').style.display = 'none'; }
        
        lucide.createIcons();
    </script>
</body>
</html>
