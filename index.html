<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Game Dev Space</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #450a0a;
            --bg-gradient-start: #7f1d1d;
            --bg-gradient-mid: #450a0a;
            --bg-gradient-end: #000000;
            --glass-bg: rgba(30, 10, 10, 0.7);
            --glass-border: rgba(255, 100, 100, 0.15);
            --scroll-thumb: #eab308;
            --scroll-track: #450a0a;
        }

        body.theme-blue {
            --bg-primary: #0f172a;
            --bg-gradient-start: #1e3a8a;
            --bg-gradient-mid: #0f172a;
            --bg-gradient-end: #000000;
            --glass-bg: rgba(15, 23, 42, 0.7);
            --glass-border: rgba(100, 200, 255, 0.15);
            --scroll-thumb: #38bdf8;
            --scroll-track: #0f172a;
        }

        body.theme-green {
            --bg-primary: #064e3b;
            --bg-gradient-start: #065f46;
            --bg-gradient-mid: #064e3b;
            --bg-gradient-end: #000000;
            --glass-bg: rgba(6, 78, 59, 0.7);
            --glass-border: rgba(52, 211, 153, 0.15);
            --scroll-thumb: #34d399;
            --scroll-track: #064e3b;
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: var(--bg-primary);
            font-family: 'Nunito', sans-serif;
            color: white;
            user-select: none;
        }

        /* --- HUB THEME --- */
        .christmas-bg {
            background: radial-gradient(circle at top, var(--bg-gradient-start) 0%, var(--bg-gradient-mid) 40%, var(--bg-gradient-end) 100%);
        }
        
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }

        .xmas-btn {
            background: linear-gradient(90deg, #ef4444 0%, #16a34a 50%, #eab308 100%);
            background-size: 200% 200%;
            animation: gradientMove 3s ease infinite;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        @keyframes gradientMove {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .hub-scroll {
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--scroll-thumb) var(--scroll-track);
        }
        .hub-scroll::-webkit-scrollbar { width: 8px; }
        .hub-scroll::-webkit-scrollbar-track { background: var(--scroll-track); }
        .hub-scroll::-webkit-scrollbar-thumb { background: var(--scroll-thumb); border-radius: 4px; }

        /* Snow Effect */
        .snowflake {
            position: absolute;
            top: -10px;
            color: #fff;
            font-size: 1em;
            opacity: 0.8;
            pointer-events: none;
            animation: fall linear infinite;
            z-index: 10;
        }
        @keyframes fall {
            0% { transform: translateY(-10vh) translateX(0); opacity: 1; }
            100% { transform: translateY(110vh) translateX(20px); opacity: 0.3; }
        }

        /* --- GAME STYLES --- */
        canvas { display: block; }
        iframe { border: none; width: 100%; height: 100%; display: block; background: white; }
        .text-outline {
            text-shadow: 2px 0 0 #000, -2px 0 0 #000, 0 2px 0 #000, 0 -2px 0 #000, 1px 1px #000, -1px -1px #000, 1px -1px #000, -1px 1px #000;
        }
        #lobby, #skinShop {
            background: radial-gradient(circle, rgba(20,30,40,0.95) 0%, rgba(10,15,20,1) 100%);
        }
        .skin-card { transition: all 0.2s; position: relative; overflow: hidden; }
        .skin-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        .skin-card.selected { border: 4px solid #4ade80; box-shadow: 0 0 15px #4ade80; }
        .skin-card.locked { filter: grayscale(100%) opacity(0.5); cursor: not-allowed; }
        .lock-overlay { background: rgba(0,0,0,0.7); }
        .control-btn { backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); user-select: none; touch-action: none; }
        
        .star-rating { display: flex; flex-direction: row-reverse; justify-content: flex-end; }
        .star-rating input { display: none; }
        .star-rating label { cursor: pointer; color: #4b5563; font-size: 1.5rem; transition: color 0.2s; }
        .star-rating label:hover, .star-rating label:hover ~ label, .star-rating input:checked ~ label { color: #fbbf24; }
    </style>
</head>
<body>

    <!-- ================================================================= -->
    <!-- CHRISTMAS HUB APPLICATION -->
    <!-- ================================================================= -->
    <div id="hub-app" class="fixed inset-0 z-50 christmas-bg flex flex-col text-gray-100">
        
        <!-- Snow Container -->
        <div id="snow-container" class="absolute inset-0 pointer-events-none overflow-hidden"></div>

        <!-- Header -->
        <header class="h-16 glass-panel border-b border-white/10 flex items-center justify-between px-6 z-20 relative">
            <div class="flex items-center gap-3 cursor-pointer" onclick="navTo('library')">
                <div class="w-10 h-10 bg-red-600 rounded-full flex items-center justify-center shadow-lg border-2 border-green-500 animate-pulse">
                    <!-- Game Controller Icon -->
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 4a2 2 0 114 0v1a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-1a2 2 0 100 4h1a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-1a2 2 0 10-4 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1v-3a1 1 0 00-1-1H4a2 2 0 110-4h1a1 1 0 001-1V7a1 1 0 011-1h3a1 1 0 001-1V4z"/></svg>
                </div>
                <div>
                    <h1 class="text-xl font-black bg-clip-text text-transparent bg-gradient-to-r from-red-400 via-green-400 to-yellow-400 drop-shadow-sm">GAME DEV SPACE</h1>
                    <p class="text-[10px] text-gray-400 uppercase tracking-widest">Jogos & Comunidade</p>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <!-- Settings Button -->
                <button onclick="document.getElementById('settings-modal').classList.remove('hidden')" class="bg-black/30 p-2 rounded-full border border-white/5 hover:bg-black/50 transition text-gray-300 hover:text-white">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                </button>
                <!-- User Profile -->
                <div onclick="navTo('profile')" class="flex items-center gap-2 bg-black/30 rounded-full px-2 py-1 border border-white/5 cursor-pointer hover:bg-black/50 transition relative group">
                    <img id="header-avatar" src="" class="w-8 h-8 rounded-full border border-red-500 object-cover">
                    <span class="text-sm font-semibold pr-2 text-green-400" id="header-username">Usuario</span>
                </div>
            </div>
        </header>

        <div class="flex flex-1 overflow-hidden relative z-10">
            <!-- Sidebar -->
            <nav class="w-64 glass-panel border-r border-white/10 flex flex-col p-4 gap-2 hidden md:flex">
                <button onclick="navTo('library')" id="nav-library" class="nav-item bg-red-500/10 text-red-400 border-l-4 border-red-500 flex items-center gap-3 px-4 py-3 rounded-r-xl transition-all">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/></svg>
                    <span>Biblioteca</span>
                </button>
                <button onclick="navTo('post')" id="nav-post" class="nav-item text-gray-400 hover:bg-white/5 hover:text-white flex items-center gap-3 px-4 py-3 rounded-r-xl transition-all border-l-4 border-transparent">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    <span>Publicar Jogo</span>
                </button>
                <button onclick="navTo('profile')" id="nav-profile" class="nav-item text-gray-400 hover:bg-white/5 hover:text-white flex items-center gap-3 px-4 py-3 rounded-r-xl transition-all border-l-4 border-transparent">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                    <span>Meu Perfil</span>
                </button>
                
                <div class="mt-auto p-4 bg-gradient-to-br from-green-900/50 to-emerald-900/50 rounded-2xl border border-white/10 relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-2 opacity-20"><svg class="w-12 h-12" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5 2a1 1 0 011 1v1h1a1 1 0 010 2H6v1a1 1 0 01-2 0V6H3a1 1 0 010-2h1V3a1 1 0 011-1zm0 9a1 1 0 011 1v1h1a1 1 0 110 2H6v1a1 1 0 11-2 0v-1H3a1 1 0 110-2h1v-1a1 1 0 011-1zm7-4a1 1 0 011 1v1h1a1 1 0 110 2h-1v1a1 1 0 11-2 0V6h-1a1 1 0 110-2h1V3a1 1 0 011-1zm0 9a1 1 0 011 1v1h1a1 1 0 110 2h-1v1a1 1 0 11-2 0v-1h-1a1 1 0 110-2h1v-1a1 1 0 011-1z" clip-rule="evenodd"/></svg></div>
                    <h3 class="font-bold text-sm mb-1 text-green-200">Feliz Natal!</h3>
                    <p class="text-xs text-gray-300">Descubra novos jogos todos os dias.</p>
                </div>
            </nav>

            <!-- Main Content Area -->
            <main id="main-content" class="flex-1 hub-scroll p-6 md:p-8 bg-black/20 relative">
                
                <!-- VIEW: LIBRARY -->
                <div id="view-library" class="space-y-8 animate-fade-in">
                    <!-- Featured Banner -->
                    <div id="featured-banner" class="relative h-72 rounded-3xl overflow-hidden shadow-2xl group cursor-pointer border border-white/10" onclick="openFeatured()">
                        <img id="feat-img" src="" class="absolute inset-0 w-full h-full object-cover transition transform group-hover:scale-105 duration-700">
                        <div class="absolute inset-0 bg-gradient-to-t from-red-950 via-red-900/50 to-transparent"></div>
                        <div class="absolute bottom-0 left-0 p-8 w-full">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="bg-yellow-500 text-black text-xs font-black px-2 py-1 rounded shadow-lg">DESTAQUE</span>
                                <span class="bg-green-600 text-white text-xs font-bold px-2 py-1 rounded flex items-center gap-1">
                                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                                    <span id="feat-rating">5.0</span>
                                </span>
                            </div>
                            <h2 id="feat-title" class="text-5xl font-black mb-2 text-white drop-shadow-lg">Título</h2>
                            <p id="feat-desc" class="text-gray-200 max-w-2xl mb-6 text-base md:text-lg line-clamp-2">Desc...</p>
                            <button class="xmas-btn text-white px-8 py-3 rounded-full font-bold flex items-center gap-2 transition transform group-hover:scale-105 shadow-xl">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"/></svg>
                                JOGAR AGORA
                            </button>
                        </div>
                    </div>

                    <!-- Filter Bar -->
                    <div class="flex items-center justify-between">
                        <h3 class="text-2xl font-bold flex items-center gap-2 text-red-200">
                            <svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                            Todos os Jogos
                        </h3>
                    </div>

                    <!-- Game Grid -->
                    <div id="game-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        <!-- Filled by JS -->
                    </div>
                </div>

                <!-- VIEW: PROFILE -->
                <div id="view-profile" class="hidden max-w-5xl mx-auto animate-fade-in">
                    <div class="relative mb-24">
                        <!-- Profile Banner -->
                        <div class="h-64 w-full rounded-2xl overflow-hidden relative group">
                            <img id="profile-banner-img" src="" class="w-full h-full object-cover">
                            <div class="absolute inset-0 bg-black/20 group-hover:bg-black/40 transition flex items-center justify-center opacity-0 group-hover:opacity-100 cursor-pointer" onclick="document.getElementById('pf-banner-upload').click()">
                                <span class="bg-black/50 text-white px-3 py-1 rounded-full text-sm backdrop-blur-md">Alterar Banner</span>
                            </div>
                            <input type="file" id="pf-banner-upload" class="hidden" accept="image/*" onchange="handleProfileUpload(this, 'banner')">
                        </div>
                        
                        <!-- Avatar & Info -->
                        <div class="absolute -bottom-16 left-8 flex items-end gap-6">
                            <div class="relative group">
                                <img id="profile-avatar-img" src="" class="w-32 h-32 rounded-full border-4 border-[#450a0a] bg-slate-800 object-cover shadow-2xl">
                                <div class="absolute inset-0 rounded-full bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 cursor-pointer transition" onclick="document.getElementById('pf-avatar-upload').click()">
                                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                                </div>
                                <input type="file" id="pf-avatar-upload" class="hidden" accept="image/*" onchange="handleProfileUpload(this, 'avatar')">
                            </div>
                            <div class="mb-2">
                                <h1 id="profile-name" class="text-4xl font-bold text-white drop-shadow-md">Nome</h1>
                                <p id="profile-bio" class="text-gray-300 max-w-lg text-sm italic mb-2">Uma breve bio...</p>
                                <a id="profile-social-link" href="#" target="_blank" class="hidden inline-flex items-center gap-2 text-green-400 hover:text-green-300 transition text-sm font-bold bg-black/40 px-3 py-1 rounded-full border border-green-900/50">
                                    <span id="profile-social-icon"></span>
                                    <span id="profile-social-text">Link</span>
                                </a>
                            </div>
                        </div>

                        <div class="absolute -bottom-12 right-8 flex gap-2">
                            <button onclick="editProfile()" class="bg-white/10 hover:bg-white/20 border border-white/20 text-white px-4 py-2 rounded-lg text-sm font-bold backdrop-blur-md transition">
                                Editar Perfil
                            </button>
                        </div>
                    </div>

                    <!-- Profile Tabs -->
                    <div class="flex gap-6 border-b border-white/10 mb-6">
                        <button onclick="switchProfileTab('created')" id="tab-created" class="pb-3 px-2 border-b-2 border-red-500 text-red-400 font-bold transition">Meus Jogos</button>
                        <button onclick="switchProfileTab('saved')" id="tab-saved" class="pb-3 px-2 border-b-2 border-transparent text-gray-400 hover:text-white transition">Jogos Salvos</button>
                    </div>

                    <div id="profile-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- JS filled -->
                    </div>

                    <!-- Edit Modal -->
                    <div id="profile-edit-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
                        <div class="bg-slate-900 border border-red-900/50 p-6 rounded-2xl w-full max-w-md shadow-2xl relative">
                            <h3 class="text-xl font-bold mb-4 text-white">Editar Perfil</h3>
                            <div class="space-y-4 max-h-[70vh] overflow-y-auto pr-2 custom-scroll">
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">Nome de Exibição</label>
                                    <input type="text" id="edit-name" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2 text-white">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">Bio</label>
                                    <textarea id="edit-bio" rows="3" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2 text-white"></textarea>
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">Avatar (URL)</label>
                                    <input type="text" id="edit-avatar-url" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2 text-white text-xs mb-1" placeholder="https://...">
                                    <p class="text-[10px] text-gray-500">Ou clique na imagem do perfil para fazer upload.</p>
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">Banner (URL)</label>
                                    <input type="text" id="edit-banner-url" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2 text-white text-xs mb-1" placeholder="https://...">
                                    <p class="text-[10px] text-gray-500">Ou clique no banner para fazer upload.</p>
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">Link Social (URL)</label>
                                    <input type="text" id="edit-social" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2 text-white">
                                </div>
                            </div>
                            <div class="flex gap-2 mt-6">
                                <button onclick="saveProfileChanges()" class="flex-1 bg-green-600 hover:bg-green-500 text-white py-2 rounded-lg font-bold">Salvar</button>
                                <button onclick="document.getElementById('profile-edit-modal').classList.add('hidden')" class="flex-1 bg-slate-700 hover:bg-slate-600 text-white py-2 rounded-lg">Cancelar</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SETTINGS MODAL -->
                <div id="settings-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
                    <div class="bg-slate-900 border border-white/10 p-6 rounded-2xl w-full max-w-sm shadow-2xl relative">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-white">Configurações</h3>
                            <button onclick="document.getElementById('settings-modal').classList.add('hidden')" class="text-gray-400 hover:text-white">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                            </button>
                        </div>
                        
                        <div class="space-y-6">
                            <div>
                                <h4 class="text-sm font-bold text-gray-400 mb-3 uppercase">Tema</h4>
                                <div class="grid grid-cols-3 gap-3">
                                    <button onclick="setTheme('red')" class="h-12 rounded-lg bg-gradient-to-br from-red-900 to-black border-2 border-red-500 hover:scale-105 transition shadow-lg relative overflow-hidden group">
                                        <div class="absolute inset-0 bg-red-500/20 group-hover:bg-red-500/40 transition"></div>
                                    </button>
                                    <button onclick="setTheme('blue')" class="h-12 rounded-lg bg-gradient-to-br from-blue-900 to-black border-2 border-transparent hover:border-blue-400 hover:scale-105 transition shadow-lg relative overflow-hidden group">
                                        <div class="absolute inset-0 bg-blue-500/20 group-hover:bg-blue-500/40 transition"></div>
                                    </button>
                                    <button onclick="setTheme('green')" class="h-12 rounded-lg bg-gradient-to-br from-green-900 to-black border-2 border-transparent hover:border-green-400 hover:scale-105 transition shadow-lg relative overflow-hidden group">
                                        <div class="absolute inset-0 bg-green-500/20 group-hover:bg-green-500/40 transition"></div>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-6 pt-6 border-t border-white/10 text-center text-xs text-gray-500">
                            Game Dev Space v1.2
                        </div>
                    </div>
                </div>

                <!-- VIEW: POST GAME -->
                <div id="view-post" class="hidden max-w-5xl mx-auto animate-fade-in">
                    <h2 class="text-3xl font-bold mb-6 flex items-center gap-2 text-green-400">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                        Publicar Novo Jogo
                    </h2>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Form -->
                        <div class="space-y-6 bg-black/40 p-6 rounded-2xl border border-white/5">
                            <div>
                                <label class="block text-sm font-medium text-gray-400 mb-1">Título do Jogo</label>
                                <input type="text" id="post-title" oninput="updatePreview()" class="w-full bg-red-950/30 border border-red-900/50 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:outline-none placeholder-gray-600" placeholder="Ex: Aventura de Natal">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-400 mb-1">Descrição</label>
                                <textarea id="post-desc" oninput="updatePreview()" rows="3" class="w-full bg-red-950/30 border border-red-900/50 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:outline-none placeholder-gray-600" placeholder="Sobre o que é seu jogo?"></textarea>
                            </div>

                            <!-- Source Code Upload -->
                            <div class="p-4 bg-green-900/20 rounded-xl border border-green-500/30">
                                <label class="block text-sm font-bold text-green-400 mb-2 flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/></svg>
                                    Código do Jogo (HTML/JS/CSS/Three.js)
                                </label>
                                <p class="text-xs text-gray-400 mb-3">Envie seu arquivo principal <b>.html</b> (ou .js/.css para bundling automático simples). Suporta Canvas, WebGL, Three.js, etc.</p>
                                <input type="file" id="post-source-file" accept=".html,.js,.css,.txt" onchange="handleSourceUpload(this)" class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-600 file:text-white hover:file:bg-green-700 cursor-pointer">
                                <div id="source-status" class="text-xs mt-2 text-yellow-500 hidden">Arquivo carregado com sucesso!</div>
                                <input type="hidden" id="post-source-content">
                            </div>

                            <!-- Images -->
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold text-gray-400 mb-2">Capa (Quadrada)</label>
                                    <input type="text" id="post-cover-url" oninput="updatePreview()" class="w-full bg-black/20 border border-white/10 rounded px-2 py-1 text-xs mb-2" placeholder="URL ou...">
                                    <input type="file" id="post-cover-file" accept="image/*" onchange="handleFileUpload(this, 'cover')" class="text-xs text-gray-500">
                                    <input type="hidden" id="post-cover-base64">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-400 mb-2">Banner (Wide)</label>
                                    <input type="text" id="post-banner-url" oninput="updatePreview()" class="w-full bg-black/20 border border-white/10 rounded px-2 py-1 text-xs mb-2" placeholder="URL ou...">
                                    <input type="file" id="post-banner-file" accept="image/*" onchange="handleFileUpload(this, 'banner')" class="text-xs text-gray-500">
                                    <input type="hidden" id="post-banner-base64">
                                </div>
                            </div>

                            <button onclick="submitGame()" class="w-full xmas-btn text-white font-bold py-3 rounded-lg shadow-lg transition transform hover:scale-[1.02]">
                                Publicar na Biblioteca
                            </button>
                        </div>

                        <!-- Preview -->
                        <div class="space-y-4">
                            <h3 class="text-sm font-bold text-gray-400 uppercase flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                                Prévia do Card
                            </h3>
                            <div id="preview-card-container" class="bg-slate-900 rounded-xl overflow-hidden shadow-2xl border border-red-900/50 w-full max-w-sm mx-auto transform transition hover:scale-105">
                                <div class="h-48 bg-slate-800 relative overflow-hidden">
                                    <img id="preview-img" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100%25' height='100%25'%3E%3Crect fill='%23334155' width='100%25' height='100%25'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='%2394a3b8' font-family='sans-serif' font-size='14'%3ESem Imagem%3C/text%3E%3C/svg%3E" class="w-full h-full object-cover">
                                    <div class="absolute top-2 right-2 bg-black/60 px-2 py-1 rounded text-xs text-yellow-400 flex items-center gap-1 font-bold">
                                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                                        0.0
                                    </div>
                                </div>
                                <div class="p-4">
                                    <h4 id="preview-title" class="font-bold text-lg mb-1 truncate text-white">Título do Jogo</h4>
                                    <p id="preview-author" class="text-gray-400 text-xs mb-3">Por: Voce</p>
                                    <div class="flex items-center justify-between text-xs text-gray-500 border-t border-slate-700 pt-3">
                                        <div class="flex gap-3">
                                            <span class="flex items-center gap-1"><svg class="w-4 h-4 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"/></svg> 0</span>
                                            <span class="flex items-center gap-1"><svg class="w-4 h-4 text-blue-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 5v8a2 2 0 01-2 2h-5l-5 4v-4H4a2 2 0 01-2-2V5a2 2 0 012-2h12a2 2 0 012 2zM7 8H5v2h2V8zm2 0h2v2H9V8zm6 0h-2v2h2V8z" clip-rule="evenodd"/></svg> 0</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VIEW: GAME DETAILS -->
                <div id="view-details" class="hidden h-full flex flex-col animate-fade-in">
                    <button onclick="navTo('library')" class="absolute top-4 left-4 z-20 bg-black/50 hover:bg-black/70 p-2 rounded-full backdrop-blur-sm transition border border-white/20 text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
                    </button>

                    <div id="detail-banner" class="h-64 w-full bg-cover bg-center relative rounded-b-3xl shrink-0 border-b border-white/10">
                        <div class="absolute inset-0 bg-gradient-to-t from-[#450a0a] to-transparent"></div>
                        <div class="absolute bottom-6 left-6 md:left-12 flex items-end gap-6">
                            <img id="detail-cover" class="w-32 h-32 rounded-xl shadow-2xl border-4 border-[#450a0a] bg-slate-800 object-cover">
                            <div class="mb-2">
                                <h1 id="detail-title" class="text-4xl font-bold text-white drop-shadow-lg">Title</h1>
                                <p id="detail-author" class="text-gray-300">Criado por Author</p>
                            </div>
                        </div>
                    </div>

                    <div class="flex-1 overflow-y-auto p-6 md:px-12">
                        <div class="flex flex-col lg:flex-row gap-8">
                            <div class="flex-1 space-y-6">
                                <div class="bg-black/40 p-6 rounded-2xl border border-white/5">
                                    <div class="flex items-center gap-4 mb-4">
                                        <button onclick="launchCurrentGame()" class="flex-1 xmas-btn text-white font-bold py-3 px-6 rounded-xl shadow-lg transition transform hover:scale-[1.02] flex justify-center items-center gap-2">
                                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"/></svg>
                                            JOGAR AGORA
                                        </button>
                                        <button id="like-btn" onclick="toggleLike()" class="bg-white/5 hover:bg-white/10 p-3 rounded-xl transition text-gray-300 border border-white/5">
                                            <svg id="like-icon" class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>
                                        </button>
                                        <button id="save-btn" onclick="toggleSave()" class="bg-white/5 hover:bg-white/10 p-3 rounded-xl transition text-gray-300 border border-white/5">
                                            <svg id="save-icon" class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/></svg>
                                        </button>
                                    </div>
                                    <h3 class="font-bold text-lg mb-2 text-green-400">Sobre o Jogo</h3>
                                    <p id="detail-desc" class="text-gray-300 leading-relaxed">Description...</p>
                                </div>

                                <!-- Comments Section -->
                                <div class="bg-black/40 p-6 rounded-2xl border border-white/5">
                                    <h3 class="font-bold text-lg mb-4 flex items-center gap-2 text-white">
                                        <svg class="w-5 h-5 text-blue-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"/></svg>
                                        Comentários & Avaliações
                                    </h3>
                                    
                                    <!-- Add Review -->
                                    <div class="mb-6 pb-6 border-b border-red-900/30">
                                        <div class="flex items-center justify-between mb-2">
                                            <span class="text-sm text-gray-400">Avaliar:</span>
                                            <div class="star-rating">
                                                <input type="radio" id="star5" name="rating" value="5" onchange="setRating(5)"/><label for="star5" title="5 estrelas">★</label>
                                                <input type="radio" id="star4" name="rating" value="4" onchange="setRating(4)"/><label for="star4" title="4 estrelas">★</label>
                                                <input type="radio" id="star3" name="rating" value="3" onchange="setRating(3)"/><label for="star3" title="3 estrelas">★</label>
                                                <input type="radio" id="star2" name="rating" value="2" onchange="setRating(2)"/><label for="star2" title="2 estrelas">★</label>
                                                <input type="radio" id="star1" name="rating" value="1" onchange="setRating(1)"/><label for="star1" title="1 estrela">★</label>
                                            </div>
                                        </div>
                                        <div class="flex gap-2 items-center">
                                            <img id="comment-input-avatar" src="" class="w-8 h-8 rounded-full object-cover border border-white/20">
                                            <input id="comment-input" type="text" class="flex-1 bg-black/20 border border-red-900/30 rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-green-500 text-white" placeholder="Escreva um comentário...">
                                            <button onclick="postComment()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-bold text-sm">Enviar</button>
                                        </div>
                                    </div>

                                    <!-- Comments List -->
                                    <div id="comments-list" class="space-y-4 max-h-64 overflow-y-auto hub-scroll pr-2">
                                        <!-- JS -->
                                    </div>
                                </div>
                            </div>

                            <!-- Sidebar Info -->
                            <div class="w-full lg:w-80 space-y-6">
                                <div class="bg-black/40 p-6 rounded-2xl border border-white/5">
                                    <div class="flex justify-between items-center mb-4 pb-2 border-b border-white/5">
                                        <span class="text-gray-400 text-sm">Avaliação Geral</span>
                                        <div class="text-yellow-400 font-bold text-xl flex items-center gap-1">
                                            <span id="detail-rating">0.0</span> 
                                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                                        </div>
                                    </div>
                                    <div class="flex justify-between items-center mb-4 pb-2 border-b border-white/5">
                                        <span class="text-gray-400 text-sm">Curtidas</span>
                                        <div class="text-red-400 font-bold flex items-center gap-1">
                                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"/></svg>
                                            <span id="detail-likes">0</span>
                                        </div>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-400 text-sm">Comentários</span>
                                        <span class="font-mono text-sm text-blue-400" id="detail-comments-count">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <!-- ================================================================= -->
    <!-- GAME WRAPPER -->
    <!-- ================================================================= -->
    <div id="game-wrapper" class="hidden fixed inset-0 z-[100] bg-black">
        
        <button id="quitGameBtn" class="fixed top-4 right-4 z-[200] bg-red-600 hover:bg-red-500 text-white px-4 py-2 rounded-lg font-bold shadow-lg flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            SAIR
        </button>

        <!-- CONTAINER FOR UPLOADED GAMES -->
        <div id="custom-game-container" class="w-full h-full hidden bg-white">
            <iframe id="game-frame"></iframe>
        </div>

        <!-- SLITHER.IO CONTAINERS -->
        <div id="slither-container" class="w-full h-full hidden">
            <canvas id="gameCanvas"></canvas>
            <div id="mobileControls" class="hidden fixed inset-0 z-40 pointer-events-none">
                <div id="joystickZone" class="pointer-events-auto absolute bottom-8 left-8 w-40 h-40 rounded-full bg-white/10 border-2 border-white/20 flex items-center justify-center control-btn">
                    <div id="joystickKnob" class="w-14 h-14 rounded-full bg-white/60 shadow-lg transform transition-transform duration-75"></div>
                </div>
                <div id="mobileBoostBtn" class="pointer-events-auto absolute bottom-10 right-10 w-24 h-24 rounded-full bg-red-500/40 border-4 border-red-400/60 flex items-center justify-center control-btn active:bg-red-500/80 active:scale-95 transition-all">
                    <svg class="w-10 h-10 text-white drop-shadow-md" fill="currentColor" viewBox="0 0 20 20"><path d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z"/></svg>
                </div>
            </div>
            <div id="lobby" class="fixed inset-0 z-50 flex flex-col items-center justify-center text-white transition-opacity duration-300">
                <div class="mb-8 text-center">
                    <h1 class="text-7xl font-bold text-green-400 text-outline tracking-wider mb-2">SLITHER.IO</h1>
                    <p class="text-gray-400 text-sm">Clone Completo v2.0</p>
                </div>
                <div class="bg-gray-800/80 p-8 rounded-2xl shadow-2xl border border-gray-700 w-96 backdrop-blur-sm relative">
                    <div class="absolute -top-6 left-1/2 transform -translate-x-1/2 bg-yellow-500 text-black font-bold px-4 py-1 rounded-full text-sm border-2 border-yellow-300 shadow-lg">
                        Recorde: <span id="lobbyHighScore">0</span>
                    </div>
                    <div class="mb-6 mt-2">
                        <label class="block text-gray-400 text-xs uppercase font-bold mb-2 ml-1">Seu Apelido</label>
                        <input type="text" id="nickname" placeholder="Nome da Cobra" maxlength="12" 
                            class="w-full px-4 py-3 bg-gray-900 border-2 border-gray-600 rounded-lg text-white focus:outline-none focus:border-green-500 text-center text-xl font-bold transition-colors">
                    </div>
                    <div class="mb-6 flex gap-4">
                        <button id="openShopBtn" class="flex-1 py-3 bg-purple-600 hover:bg-purple-500 text-white font-bold rounded-lg shadow-lg transform transition hover:-translate-y-1 active:translate-y-0 border-b-4 border-purple-800 flex flex-col items-center justify-center">
                            <span class="text-xs uppercase opacity-75">Skin Atual</span>
                            <div class="flex items-center gap-2 mt-1">
                                <div id="currentSkinPreview" class="w-6 h-6 rounded-full border-2 border-white"></div>
                                <span>LOJA</span>
                            </div>
                        </button>
                    </div>
                    <button id="playBtn" class="w-full py-4 bg-green-600 hover:bg-green-500 text-white font-bold text-2xl rounded-lg shadow-lg transform transition hover:-translate-y-1 active:translate-y-0 border-b-4 border-green-800">
                        JOGAR AGORA
                    </button>
                </div>
            </div>
            <div id="skinShop" class="hidden fixed inset-0 z-[60] flex flex-col items-center justify-center text-white backdrop-blur-md">
                <div class="bg-gray-900 p-6 rounded-xl shadow-2xl border border-gray-700 w-[800px] max-w-full h-[600px] flex flex-col">
                    <div class="flex justify-between items-center mb-6 pb-4 border-b border-gray-700">
                        <h2 class="text-3xl font-bold text-white"><span class="text-purple-400">LOJA</span> DE SKINS</h2>
                        <div class="text-right">
                            <div class="text-xs text-gray-400 uppercase">Seu Recorde</div>
                            <div class="text-2xl font-bold text-yellow-400" id="shopHighScore">0</div>
                        </div>
                    </div>
                    <div id="skinsGrid" class="flex-1 overflow-y-auto custom-scroll grid grid-cols-4 gap-4 p-2"></div>
                    <div class="mt-6 pt-4 border-t border-gray-700 flex justify-end">
                        <button id="closeShopBtn" class="px-8 py-2 bg-gray-600 hover:bg-gray-500 text-white font-bold rounded-lg transition">Voltar</button>
                    </div>
                </div>
            </div>
            <div id="hud" class="hidden absolute inset-0 pointer-events-none">
                <div class="absolute bottom-4 left-4 text-white z-10">
                    <div class="text-gray-400 text-xs uppercase font-bold">Seu Tamanho</div>
                    <div id="scoreDisplay" class="text-2xl font-bold">10</div>
                </div>
                <div class="absolute top-4 right-4 bg-black/40 p-4 rounded-lg w-48 text-white z-10 backdrop-blur-sm">
                    <h3 class="text-gray-300 text-xs uppercase font-bold mb-2 text-center border-b border-gray-600 pb-1">Leaderboard</h3>
                    <ul id="leaderboard" class="text-sm space-y-1 font-mono"></ul>
                </div>
                <div class="absolute bottom-4 right-4 w-32 h-32 bg-gray-900/80 rounded-full border-2 border-gray-600 overflow-hidden opacity-80 z-10">
                     <canvas id="minimap" width="128" height="128" class="w-full h-full"></canvas>
                </div>
            </div>
            <div id="gameOver" class="hidden fixed inset-0 z-50 flex flex-col items-center justify-center bg-black/80 text-white backdrop-blur-sm">
                <h2 class="text-5xl font-bold text-red-500 text-outline mb-4">VOCÊ MORREU!</h2>
                <div class="text-2xl mb-2">Tamanho Final: <span id="finalScore" class="font-bold text-green-400">0</span></div>
                <div class="text-xl mb-8 text-gray-400">Morto por: <span id="killedBy" class="font-bold text-white">Ninguém</span></div>
                <button id="restartBtn" class="px-8 py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold text-xl rounded-lg shadow-lg transition">Jogar Novamente</button>
            </div>
        </div>
    </div>

    <!-- ================================================================= -->
    <!-- LOGIC -->
    <!-- ================================================================= -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, onDisconnect, remove, update as fbUpdate } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // --- HUB DATA & LOGIC ---
        
        // Initial Data
        let currentUser = {
            name: 'Guest Player',
            avatar: 'https://ui-avatars.com/api/?name=Guest+Player&background=16a34a&color=fff',
            banner: 'https://images.unsplash.com/photo-1542273917363-3b1817f69a2d?q=80&w=1600&auto=format&fit=crop',
            bio: 'Desenvolvedor apaixonado por WebGL e Canvas.',
            social: 'https://github.com/guestplayer',
            createdGames: [], // List of IDs
            savedGames: [] // List of IDs
        };

        // Helper to simulate social interaction
        const getInitialLikes = () => {
            const set = new Set();
            for(let i=0; i<1240; i++) set.add(`user${i}`);
            return set;
        };

        const getInitialRatings = () => {
            return { 'Noel': 5, 'Elf': 4, 'Santa': 5, 'Rudolph': 5, 'Frosty': 4 };
        };

        let games = [
            {
                id: 'slither-io',
                title: 'Slither.io Clone',
                description: 'A clássica experiência das cobrinhas. Jogue agora com skins exclusivas de Natal! Coma pontos, cresça e domine a arena. Suporta multiplayer em tempo real via Firebase.',
                author: 'System',
                cover: 'https://images.unsplash.com/photo-1628260412297-a3377e45006f?q=80&w=400&auto=format&fit=crop',
                banner: 'https://images.unsplash.com/photo-1605218427306-6354db696bea?q=80&w=1920&auto=format&fit=crop',
                rating: 4.6, // Initial calc: 23 / 5 = 4.6
                ratings: getInitialRatings(), // Raw data
                likes: getInitialLikes(), // Set of UserIDs
                comments: [
                    { user: 'Noel', avatar: 'https://ui-avatars.com/api/?name=Noel&background=red&color=fff', text: 'Ho Ho Ho! Jogo muito divertido!' }
                ],
                source: null
            }
        ];

        let activeGameId = null;
        let profileTab = 'created';

        // --- GLOBAL HELPERS ---
        window.setTheme = function(theme) {
            document.body.className = ''; // reset
            if(theme === 'blue') document.body.classList.add('theme-blue');
            if(theme === 'green') document.body.classList.add('theme-green');
            // default is red/base
        };
        window.navTo = function(pageId) {
            document.querySelectorAll('main > div').forEach(div => div.classList.add('hidden'));
            const target = document.getElementById(`view-${pageId}`);
            if(target) target.classList.remove('hidden');
            
            // Sidebar active states
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.classList.remove('bg-red-500/10', 'text-red-400', 'border-red-500');
                btn.classList.add('text-gray-400', 'border-transparent');
            });
            const activeBtn = document.getElementById(`nav-${pageId}`);
            if(activeBtn) {
                activeBtn.classList.remove('text-gray-400', 'border-transparent');
                activeBtn.classList.add('bg-red-500/10', 'text-red-400', 'border-red-500');
            }

            if(pageId === 'profile') renderProfile();
            if(pageId === 'library') renderLibrary();
        };

        // --- PROFILE SYSTEM ---
        function renderProfile() {
            document.getElementById('profile-name').innerText = currentUser.name;
            document.getElementById('profile-bio').innerText = currentUser.bio;
            document.getElementById('profile-avatar-img').src = currentUser.avatar;
            document.getElementById('profile-banner-img').src = currentUser.banner;
            document.getElementById('header-avatar').src = currentUser.avatar;
            document.getElementById('header-username').innerText = currentUser.name;
            const commentAvatar = document.getElementById('comment-input-avatar');
            if(commentAvatar) commentAvatar.src = currentUser.avatar;
            
            // Social Link Logic
            const socialLinkEl = document.getElementById('profile-social-link');
            if (currentUser.social) {
                socialLinkEl.classList.remove('hidden');
                socialLinkEl.href = currentUser.social;
                const iconEl = document.getElementById('profile-social-icon');
                const textEl = document.getElementById('profile-social-text');
                
                let iconSvg = '';
                let label = 'Website';
                
                const url = currentUser.social.toLowerCase();
                if(url.includes('github')) {
                    iconSvg = '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.285 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/></svg>';
                    label = 'GitHub';
                } else if (url.includes('youtube')) {
                    iconSvg = '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>';
                    label = 'YouTube';
                } else if (url.includes('twitter') || url.includes('x.com')) {
                    iconSvg = '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>';
                    label = 'X / Twitter';
                } else if (url.includes('instagram')) {
                    iconSvg = '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zM12 0C8.741 0 8.333.014 7.053.072 2.695.272.273 2.69.073 7.052.014 8.333 0 8.741 0 12c0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98C8.333 23.986 8.741 24 12 24c3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98C15.668.014 15.259 0 12 0zm0 5.838a6.162 6.162 0 100 12.324 6.162 6.162 0 000-12.324zM12 16a4 4 0 110-8 4 4 0 010 8zm6.406-11.845a1.44 1.44 0 100 2.881 1.44 1.44 0 000-2.881z"/></svg>';
                    label = 'Instagram';
                } else {
                    iconSvg = '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71" fill="none" stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71" fill="none" stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/></svg>';
                }
                
                iconEl.innerHTML = iconSvg;
                textEl.innerText = label;
            } else {
                socialLinkEl.classList.add('hidden');
            }
            
            renderProfileGrid();
        }

        window.switchProfileTab = function(tab) {
            profileTab = tab;
            const btnCreated = document.getElementById('tab-created');
            const btnSaved = document.getElementById('tab-saved');
            
            // Clear both
            btnCreated.className = "pb-3 px-2 border-b-2 transition cursor-pointer";
            btnSaved.className = "pb-3 px-2 border-b-2 transition cursor-pointer";

            if(tab === 'created') {
                btnCreated.classList.add('border-red-500', 'text-red-400', 'font-bold');
                btnSaved.classList.add('border-transparent', 'text-gray-400', 'hover:text-white');
            } else {
                btnSaved.classList.add('border-red-500', 'text-red-400', 'font-bold');
                btnCreated.classList.add('border-transparent', 'text-gray-400', 'hover:text-white');
            }
            renderProfileGrid();
        }

        function renderProfileGrid() {
            const grid = document.getElementById('profile-grid');
            grid.innerHTML = '';
            
            let list = [];
            if(profileTab === 'created') {
                // Ensure we only get unique games and ones that exist
                list = games.filter(g => (g.author === currentUser.name || currentUser.createdGames.includes(g.id)));
            } else {
                // Filter games that are in savedGames array
                list = games.filter(g => currentUser.savedGames.includes(g.id));
            }

            if(list.length === 0) {
                grid.innerHTML = `<div class="col-span-3 text-center text-gray-400 py-10">Nenhum jogo encontrado nesta aba.</div>`;
                return;
            }

            list.forEach(game => {
                grid.innerHTML += createGameCard(game);
            });
        }

        window.editProfile = function() {
            document.getElementById('edit-name').value = currentUser.name;
            document.getElementById('edit-bio').value = currentUser.bio;
            document.getElementById('edit-social').value = currentUser.social;
            document.getElementById('edit-avatar-url').value = '';
            document.getElementById('edit-banner-url').value = '';
            document.getElementById('profile-edit-modal').classList.remove('hidden');
        };

        window.saveProfileChanges = function() {
            currentUser.name = document.getElementById('edit-name').value;
            currentUser.bio = document.getElementById('edit-bio').value;
            currentUser.social = document.getElementById('edit-social').value;
            
            const avaUrl = document.getElementById('edit-avatar-url').value;
            const banUrl = document.getElementById('edit-banner-url').value;
            if(avaUrl && avaUrl.trim() !== '') currentUser.avatar = avaUrl;
            if(banUrl && banUrl.trim() !== '') currentUser.banner = banUrl;

            document.getElementById('profile-edit-modal').classList.add('hidden');
            renderProfile();
        };

        window.handleProfileUpload = function(input, type) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    if(type === 'avatar') currentUser.avatar = e.target.result;
                    if(type === 'banner') currentUser.banner = e.target.result;
                    renderProfile();
                };
                reader.readAsDataURL(input.files[0]);
            }
        };

        // --- LIBRARY & UPLOADS ---

        function createGameCard(game) {
            return `
                <div onclick="openGameDetails('${game.id}')" class="bg-black/30 rounded-xl overflow-hidden shadow-lg border border-white/5 hover:border-green-500 hover:scale-105 transition cursor-pointer group flex flex-col">
                    <div class="h-48 relative overflow-hidden shrink-0">
                        <img src="${game.cover}" class="w-full h-full object-cover transition duration-500 group-hover:scale-110">
                        <div class="absolute top-2 right-2 bg-black/60 px-2 py-1 rounded text-xs text-yellow-400 flex items-center gap-1 font-bold">
                            <svg class="w-3 h-3 text-yellow-400" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                            ${(typeof game.rating === 'number' ? game.rating : 0).toFixed(1)}
                        </div>
                    </div>
                    <div class="p-4 flex flex-col flex-1">
                        <h4 class="font-bold text-lg mb-1 truncate text-white">${game.title}</h4>
                        <p class="text-gray-400 text-xs mb-3">Por ${game.author}</p>
                        <div class="mt-auto flex items-center justify-between text-xs text-gray-500 border-t border-white/10 pt-3">
                            <div class="flex gap-3">
                                <span class="flex items-center gap-1 text-red-400">
                                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"/></svg>
                                    ${game.likes.size}
                                </span>
                                <span class="flex items-center gap-1 text-blue-400">
                                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"/></svg>
                                    ${game.comments.length}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderLibrary() {
            // Sort by rating for Featured
            const sortedGames = [...games].sort((a,b) => (b.rating * b.likes.size) - (a.rating * a.likes.size));
            const featured = sortedGames[0];
            
            if(featured) {
                document.getElementById('feat-title').innerText = featured.title;
                document.getElementById('feat-desc').innerText = featured.description;
                document.getElementById('feat-img').src = featured.banner;
                document.getElementById('feat-rating').innerText = featured.rating.toFixed(1);
                document.getElementById('featured-banner').onclick = () => openGameDetails(featured.id);
            }

            const grid = document.getElementById('game-grid');
            grid.innerHTML = '';
            games.forEach(game => {
                grid.innerHTML += createGameCard(game);
            });
        }

        // Post System
        window.handleFileUpload = function(input, target) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById(`post-${target}-base64`).value = e.target.result;
                    updatePreview();
                };
                reader.readAsDataURL(input.files[0]);
            }
        };

        window.handleSourceUpload = function(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    let content = e.target.result;
                    
                    // If user uploads JS or CSS directly, wrap it in a minimal HTML shell
                    if (file.name.endsWith('.js')) {
                        const jsCode = content; // raw text
                         // Create a blob URL-like structure but as Data URL
                         const htmlContent = `<!DOCTYPE html><html><head><style>body{margin:0;overflow:hidden;background:#000;}</style></head><body><script>${jsCode}<\/script></body></html>`;
                         document.getElementById('post-source-content').value = "data:text/html;base64," + btoa(htmlContent);
                    } else if (file.name.endsWith('.css')) {
                         const cssCode = content;
                         const htmlContent = `<!DOCTYPE html><html><head><style>${cssCode}</style></head><body><h1>CSS Only Preview</h1></body></html>`;
                         document.getElementById('post-source-content').value = "data:text/html;base64," + btoa(htmlContent);
                    } else {
                        // Assume HTML or use readAsDataURL result directly
                        // Note: For .js/.css above we need readAsText, for HTML readAsDataURL is fine for iframe src
                         document.getElementById('post-source-content').value = content;
                    }
                    
                    document.getElementById('source-status').innerText = `Arquivo ${file.name} carregado!`;
                    document.getElementById('source-status').classList.remove('hidden');
                };

                if (file.name.endsWith('.js') || file.name.endsWith('.css') || file.name.endsWith('.txt')) {
                    reader.readAsText(file); // Read code as text to wrap it
                } else {
                    reader.readAsDataURL(file); // Read HTML as data URL
                }
            }
        };

        window.updatePreview = function() {
            const title = document.getElementById('post-title').value || 'Título do Jogo';
            const author = currentUser.name;
            let coverSrc = document.getElementById('post-cover-base64').value || document.getElementById('post-cover-url').value;
            if(!coverSrc) coverSrc = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100%25' height='100%25'%3E%3Crect fill='%23334155' width='100%25' height='100%25'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='%2394a3b8' font-family='sans-serif' font-size='14'%3ESem Imagem%3C/text%3E%3C/svg%3E";

            document.getElementById('preview-title').innerText = title;
            document.getElementById('preview-author').innerText = 'Por: ' + author;
            document.getElementById('preview-img').src = coverSrc;
        };

        window.submitGame = function() {
            const title = document.getElementById('post-title').value;
            const desc = document.getElementById('post-desc').value;
            const source = document.getElementById('post-source-content').value;
            let cover = document.getElementById('post-cover-base64').value || document.getElementById('post-cover-url').value;
            let banner = document.getElementById('post-banner-base64').value || document.getElementById('post-banner-url').value;

            if(!title) return alert('Por favor, insira o título!');
            if(!cover) cover = 'https://via.placeholder.com/400';
            if(!banner) banner = 'https://via.placeholder.com/1920x1080';

            const newId = 'game-' + Date.now();
            const newGame = {
                id: newId,
                title,
                description: desc || 'Sem descrição.',
                author: currentUser.name,
                cover,
                banner,
                rating: 0,
                ratings: {},
                likes: new Set(),
                comments: [],
                source: source || null
            };

            games.unshift(newGame);
            currentUser.createdGames.push(newId);
            
            navTo('library');
            
            // Reset
            document.getElementById('post-title').value = '';
            document.getElementById('post-desc').value = '';
            document.getElementById('post-cover-url').value = '';
            document.getElementById('post-banner-url').value = '';
            document.getElementById('post-source-content').value = '';
            document.getElementById('post-cover-base64').value = '';
            document.getElementById('post-banner-base64').value = '';
            document.getElementById('source-status').classList.add('hidden');
            updatePreview();
        };

        // Game Details & Interaction
        window.openGameDetails = function(id) {
            const game = games.find(g => g.id === id);
            if (!game) return;
            activeGameId = id;
            window.activeGame = game; // Helper

            document.getElementById('detail-title').innerText = game.title;
            document.getElementById('detail-author').innerText = `Criado por ${game.author}`;
            document.getElementById('detail-desc').innerText = game.description;
            document.getElementById('detail-cover').src = game.cover;
            document.getElementById('detail-banner').style.backgroundImage = `url(${game.banner})`;
            document.getElementById('detail-rating').innerText = game.rating.toFixed(1);
            document.getElementById('detail-likes').innerText = game.likes.size;
            document.getElementById('detail-comments-count').innerText = game.comments.length;

            // Update Star Inputs
            const myRating = game.ratings[currentUser.name] || 0;
            document.querySelectorAll('input[name="rating"]').forEach(inp => {
                inp.checked = parseInt(inp.value) === myRating;
            });

            updateInteractionButtons();
            renderComments(game);
            navTo('details');
        };

        window.setRating = function(val) {
            if(!activeGameId) return;
            const game = games.find(g => g.id === activeGameId);
            if(!game) return;
            
            game.ratings[currentUser.name] = parseInt(val);
            
            // Recalc Average
            const values = Object.values(game.ratings);
            const sum = values.reduce((a,b) => a+b, 0);
            game.rating = sum / values.length;
            
            document.getElementById('detail-rating').innerText = game.rating.toFixed(1);
        }

        function updateInteractionButtons() {
            const game = games.find(g => g.id === activeGameId);
            
            // Like State
            const likeIcon = document.getElementById('like-icon');
            const likeBtn = document.getElementById('like-btn');
            
            if(game && game.likes.has(currentUser.name)) {
                likeIcon.classList.add('text-red-500', 'fill-current');
                likeBtn.classList.add('bg-white/20');
            } else {
                likeIcon.classList.remove('text-red-500', 'fill-current');
                likeBtn.classList.remove('bg-white/20');
            }
            
            // Save State
            const saveIcon = document.getElementById('save-icon');
            const saveBtn = document.getElementById('save-btn');
            
            if(currentUser.savedGames.includes(activeGameId)) {
                saveIcon.classList.add('text-yellow-400', 'fill-current');
                saveBtn.classList.add('bg-white/20');
            } else {
                saveIcon.classList.remove('text-yellow-400', 'fill-current');
                saveBtn.classList.remove('bg-white/20');
            }
        }

        window.toggleSave = function() {
            const idx = currentUser.savedGames.indexOf(activeGameId);
            if(idx > -1) {
                currentUser.savedGames.splice(idx, 1);
            } else {
                currentUser.savedGames.push(activeGameId);
            }
            // If in profile saved tab, refresh grid
            if(profileTab === 'saved') renderProfileGrid();
            
            updateInteractionButtons();
        }

        window.toggleLike = function() {
            const game = games.find(g => g.id === activeGameId);
            if(!game) return;
            
            if(game.likes.has(currentUser.name)) {
                game.likes.delete(currentUser.name);
            } else {
                game.likes.add(currentUser.name);
            }
            
            document.getElementById('detail-likes').innerText = game.likes.size;
            updateInteractionButtons();
        }

        window.postComment = function() {
            const input = document.getElementById('comment-input');
            const text = input.value.trim();
            if(!text || !activeGameId) return;

            const game = games.find(g => g.id === activeGameId);
            game.comments.unshift({
                user: currentUser.name,
                text: text,
                avatar: currentUser.avatar
            });
            input.value = '';
            renderComments(game);
            document.getElementById('detail-comments-count').innerText = game.comments.length;
        };

        function renderComments(game) {
            const list = document.getElementById('comments-list');
            list.innerHTML = '';
            if(game.comments.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-500 py-4 italic">Seja o primeiro a comentar!</div>';
                return;
            }
            game.comments.forEach(c => {
                list.innerHTML += `
                    <div class="flex gap-3 text-sm bg-black/30 p-3 rounded-xl border border-white/5">
                        <img src="${c.avatar}" class="w-8 h-8 rounded-full object-cover">
                        <div>
                            <div class="font-bold text-gray-300 text-xs mb-1">${c.user}</div>
                            <div class="text-gray-400">${c.text}</div>
                        </div>
                    </div>
                `;
            });
        }
        
        window.openFeatured = function() {
             // Logic handled in renderLibrary but generic if needed
        }

        // --- GAME LAUNCHER ---
        
        let slitherGameActive = false;

        window.launchCurrentGame = function() {
            const game = games.find(g => g.id === activeGameId);
            if(!game) return;

            document.getElementById('hub-app').classList.add('hidden');
            document.getElementById('game-wrapper').classList.remove('hidden');

            const slitherContainer = document.getElementById('slither-container');
            const customContainer = document.getElementById('custom-game-container');
            const iframe = document.getElementById('game-frame');

            if(game.id === 'slither-io') {
                slitherContainer.classList.remove('hidden');
                customContainer.classList.add('hidden');
                slitherGameActive = true;
                resize();
                gameState = 'LOBBY';
                document.getElementById('lobby').classList.remove('hidden');
                document.getElementById('hud').classList.add('hidden');
            } else if (game.source) {
                slitherContainer.classList.add('hidden');
                customContainer.classList.remove('hidden');
                iframe.src = game.source; // Load the HTML content
            } else {
                alert("Este é um jogo de demonstração visual (sem arquivo fonte carregado).");
                quitGame();
            }
        };

        window.quitGame = function() {
            slitherGameActive = false;
            document.getElementById('game-wrapper').classList.add('hidden');
            document.getElementById('hub-app').classList.remove('hidden');
            
            // Clear iframe
            document.getElementById('game-frame').src = 'about:blank';
            
            // Clean Slither
            gameState = 'LOBBY';
            document.getElementById('gameOver').classList.add('hidden');
            if(playerRef) remove(playerRef);
        };
        
        document.getElementById('quitGameBtn').addEventListener('click', quitGame);

        // --- SNOW ---
        function createSnow() {
            const container = document.getElementById('snow-container');
            const flakes = 30; 
            for (let i = 0; i < flakes; i++) {
                const flake = document.createElement('div');
                flake.className = 'snowflake';
                flake.innerHTML = '❄';
                flake.style.left = Math.random() * 100 + 'vw';
                flake.style.animationDuration = Math.random() * 5 + 5 + 's';
                flake.style.fontSize = Math.random() * 10 + 10 + 'px';
                flake.style.animationDelay = Math.random() * 5 + 's';
                container.appendChild(flake);
            }
        }

        // Initialize
        createSnow();
        renderProfile(); // Init profile data
        renderLibrary();

        // =================================================================
        // SLITHER.IO GAME LOGIC (Unchanged, just kept in scope)
        // =================================================================
        
        const firebaseConfig = {
            apiKey: "AIzaSyCfdgkO3WzaxXT-djAA6MsLC2m26c9optU",
            authDomain: "slider-io.firebaseapp.com",
            databaseURL: "https://slider-io-default-rtdb.firebaseio.com",
            projectId: "slider-io",
            storageBucket: "slider-io.firebasestorage.app",
            messagingSenderId: "395647141464",
            appId: "1:395647141464:web:251cc58a3e0e90ca262c2d"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const CONFIG = {
            worldSize: 3000,
            initialMass: 20, 
            baseSpeed: 5, 
            boostSpeed: 10,
            baseRotationSpeed: 0.12, 
            foodCount: 1200,
            foodBaseVal: 0.3,
            widthFactor: 0.4
        };

        const SKINS = [
            { id: 1, name: "Vermelho", type: "color", value: "#FF3333", unlock: 0 },
            { id: 2, name: "Verde", type: "color", value: "#00FF00", unlock: 0 },
            { id: 3, name: "Azul", type: "color", value: "#0055FF", unlock: 0 },
            { id: 4, name: "Amarelo", type: "color", value: "#FFFF00", unlock: 0 },
            { id: 5, name: "Roxo", type: "color", value: "#8800FF", unlock: 0 },
            { id: 6, name: "Ciano", type: "color", value: "#00FFFF", unlock: 100 },
            { id: 7, name: "Rosa", type: "color", value: "#FF00FF", unlock: 200 },
            { id: 8, name: "Laranja", type: "color", value: "#FF8800", unlock: 300 },
            { id: 9, name: "Branco", type: "color", value: "#FFFFFF", unlock: 400 },
            { id: 10, name: "Sombra", type: "color", value: "#333333", unlock: 500 },
            { id: 11, name: "Abelha", type: "pattern", value: ["#FFFF00", "#222222"], unlock: 800 },
            { id: 12, name: "EUA", type: "pattern", value: ["#FF0000", "#FFFFFF", "#0000FF"], unlock: 1000 },
            { id: 13, name: "Alemanha", type: "pattern", value: ["#000000", "#FF0000", "#FFFF00"], unlock: 1200 },
            { id: 14, name: "Brasil", type: "pattern", value: ["#00FF00", "#FFFF00", "#0055FF"], unlock: 1500 },
            { id: 15, name: "Arco-íris", type: "pattern", value: ["#FF0000", "#FF7F00", "#FFFF00", "#00FF00", "#0000FF", "#4B0082", "#9400D3"], unlock: 2000 },
            { id: 16, name: "Matrix", type: "pattern", value: ["#003300", "#00FF00"], unlock: 2500 },
            { id: 17, name: "Lava", type: "pattern", value: ["#550000", "#FF0000", "#FF8800"], unlock: 3000 },
            { id: 18, name: "Zebra", type: "pattern", value: ["#FFFFFF", "#000000"], unlock: 3500 },
            { id: 19, name: "Dourado", type: "color", value: "#FFD700", unlock: 5000 },
        ];

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const minimapCanvas = document.getElementById('minimap');
        const minimapCtx = minimapCanvas.getContext('2d');
        
        let gameState = 'LOBBY'; 
        let width, height;
        let camera = { x: 0, y: 0, scale: 1 };
        let mouse = { x: 0, y: 0, active: false };
        let boostKey = false;
        
        let isMobile = false;
        let joystick = { active: false, angle: 0, dx: 0, dy: 0 };
        
        let highScore = parseInt(localStorage.getItem('slither_highscore')) || 0;
        let selectedSkinId = parseInt(localStorage.getItem('slither_skin')) || 1;

        let player;
        let snakes = {}; 
        let foods = [];
        let particles = [];
        
        let frame = 0;
        let playerId = null;
        let playerRef = null;

        const rand = (min, max) => Math.random() * (max - min) + min;
        const dist = (x1, y1, x2, y2) => Math.hypot(x2 - x1, y2 - y1);
        
        class Food {
            constructor(x, y, mass = CONFIG.foodBaseVal, color = null) {
                this.x = x || rand(-CONFIG.worldSize, CONFIG.worldSize);
                this.y = y || rand(-CONFIG.worldSize, CONFIG.worldSize);
                this.mass = mass;
                this.radius = 3 + (mass * 3);
                const colors = ['#FF3333', '#00FF00', '#0055FF', '#FFFF00', '#00FFFF', '#FF00FF'];
                this.color = color || colors[Math.floor(Math.random() * colors.length)];
            }
            draw(ctx) {
                ctx.globalAlpha = 1;
                ctx.fillStyle = this.color;
                if (this.mass > 1) { ctx.shadowBlur = 5; ctx.shadowColor = this.color; }
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fill();
                ctx.shadowBlur = 0;
            }
        }

        class Particle {
            constructor(x, y, color) {
                this.x = x; this.y = y; this.color = color;
                this.life = 1.0; this.vx = rand(-3, 3); this.vy = rand(-3, 3);
            }
            update() { this.x += this.vx; this.y += this.vy; this.life -= 0.02; }
            draw(ctx) {
                ctx.globalAlpha = this.life;
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, 4, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1;
            }
        }

        class Snake {
            constructor(id, x, y, name = "Anon", skinId = 1, isMe = false) {
                this.id = id; this.x = x; this.y = y;
                this.angle = 0; this.targetAngle = 0;
                this.mass = CONFIG.initialMass;
                this.name = name; this.isMe = isMe;
                this.skin = SKINS.find(s => s.id === skinId) || SKINS[0];
                this.width = 20; this.history = []; 
                this.dead = false; this.boosting = false;
                this.lastUpdate = Date.now();
                this.targetX = x; this.targetY = y;
                for (let i = 0; i < this.mass * 5; i++) { this.history.push({x: this.x, y: this.y}); }
            }
            update() {
                if (this.dead) return;
                if (this.isMe) this.playerLogic(); else this.networkLogic();
                if (this.isMe) {
                    const currentSpeed = this.boosting && this.mass > 10 ? CONFIG.boostSpeed : CONFIG.baseSpeed;
                    const vx = Math.cos(this.angle) * currentSpeed;
                    const vy = Math.sin(this.angle) * currentSpeed;
                    this.x += vx; this.y += vy;
                    if (this.x < -CONFIG.worldSize) this.x = -CONFIG.worldSize;
                    if (this.x > CONFIG.worldSize) this.x = CONFIG.worldSize;
                    if (this.y < -CONFIG.worldSize) this.y = -CONFIG.worldSize;
                    if (this.y > CONFIG.worldSize) this.y = CONFIG.worldSize;
                    if (frame % 3 === 0) this.sync();
                }
                this.history.unshift({x: this.x, y: this.y});
                const targetLength = 20 + (this.mass * 2.5); 
                while (this.history.length > targetLength * 4) { this.history.pop(); }
                if (this.isMe && this.boosting && this.mass > 10 && frame % 8 === 0) {
                    this.mass -= 0.5;
                    const dropX = this.history[this.history.length-1].x;
                    const dropY = this.history[this.history.length-1].y;
                    let dropColor = this.skin.type === 'color' ? this.skin.value : this.skin.value[0];
                    foods.push(new Food(dropX + rand(-10,10), dropY + rand(-10,10), 0.3, dropColor));
                }
                this.width = 20 + Math.sqrt(this.mass * CONFIG.widthFactor);
            }
            playerLogic() {
                if (joystick.active) { this.targetAngle = joystick.angle; } 
                else {
                    const dx = mouse.x - width / 2;
                    const dy = mouse.y - height / 2;
                    this.targetAngle = Math.atan2(dy, dx);
                }
                this.boosting = mouse.active || boostKey;
                const turnSpeed = CONFIG.baseRotationSpeed * (25 / (25 + this.width));
                let diff = this.targetAngle - this.angle;
                while (diff < -Math.PI) diff += Math.PI * 2;
                while (diff > Math.PI) diff -= Math.PI * 2;
                if (Math.abs(diff) < turnSpeed) { this.angle = this.targetAngle; } 
                else { this.angle += Math.sign(diff) * turnSpeed; }
            }
            networkLogic() {
                const lerp = 0.3;
                this.x += (this.targetX - this.x) * lerp;
                this.y += (this.targetY - this.y) * lerp;
            }
            sync() {
                if (!playerRef) return;
                fbUpdate(playerRef, {
                    x: Math.round(this.x), y: Math.round(this.y),
                    angle: this.angle, mass: Math.round(this.mass),
                    boosting: this.boosting, skinId: this.skin.id,
                    name: this.name, timestamp: Date.now()
                });
            }
            draw(ctx) {
                const segmentSpacing = 5; 
                let colors = this.skin.type === 'color' ? [this.skin.value] : this.skin.value;
                for (let i = 0; i < this.history.length; i+=segmentSpacing) {
                    const point = this.history[i];
                    const size = this.width - (i / this.history.length) * 10;
                    if (size < 0) continue;
                    const colorIndex = Math.floor(i / (segmentSpacing * 3)) % colors.length;
                    ctx.fillStyle = colors[colorIndex];
                    ctx.beginPath();
                    ctx.arc(point.x, point.y, size / 2, 0, Math.PI * 2);
                    ctx.fill();
                }
                ctx.fillStyle = colors[0];
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.width / 2, 0, Math.PI * 2);
                ctx.fill();
                const eyeOffset = this.width / 3;
                const eyeSize = this.width / 4;
                const eyeX1 = this.x + Math.cos(this.angle - 0.5) * eyeOffset;
                const eyeY1 = this.y + Math.sin(this.angle - 0.5) * eyeOffset;
                const eyeX2 = this.x + Math.cos(this.angle + 0.5) * eyeOffset;
                const eyeY2 = this.y + Math.sin(this.angle + 0.5) * eyeOffset;
                ctx.fillStyle = "white";
                ctx.beginPath(); ctx.arc(eyeX1, eyeY1, eyeSize, 0, Math.PI * 2); ctx.fill();
                ctx.beginPath(); ctx.arc(eyeX2, eyeY2, eyeSize, 0, Math.PI * 2); ctx.fill();
                ctx.fillStyle = "black";
                ctx.beginPath(); ctx.arc(eyeX1 + Math.cos(this.angle)*2, eyeY1 + Math.sin(this.angle)*2, eyeSize/2, 0, Math.PI * 2); ctx.fill();
                ctx.beginPath(); ctx.arc(eyeX2 + Math.cos(this.angle)*2, eyeY2 + Math.sin(this.angle)*2, eyeSize/2, 0, Math.PI * 2); ctx.fill();
                ctx.fillStyle = "white"; ctx.strokeStyle = "black"; ctx.lineWidth = 2;
                ctx.font = "bold 12px Arial"; ctx.textAlign = "center";
                ctx.strokeText(this.name, this.x, this.y - this.width);
                ctx.fillText(this.name, this.x, this.y - this.width);
            }
        }

        function init() {
            resize();
            window.addEventListener('resize', resize);
            updateLobbyUI();
            
            const playersRef = ref(db, 'players');
            onValue(playersRef, (snapshot) => {
                const data = snapshot.val();
                if (!data) {
                    Object.keys(snakes).forEach(id => { if (snakes[id] !== player) delete snakes[id]; });
                    return;
                }
                Object.keys(data).forEach(key => {
                    if (playerId && key === playerId) return; 
                    const pData = data[key];
                    if (pData.dead) {
                        if (snakes[key]) { killSnake(snakes[key], "Someone", false); delete snakes[key]; }
                        return;
                    }
                    if (!snakes[key]) { snakes[key] = new Snake(key, pData.x, pData.y, pData.name, pData.skinId, false); }
                    const s = snakes[key];
                    s.targetX = pData.x; s.targetY = pData.y; s.angle = pData.angle;
                    s.mass = pData.mass; s.boosting = pData.boosting; s.lastUpdate = Date.now();
                });
                Object.keys(snakes).forEach(key => { if (key !== playerId && !data[key]) delete snakes[key]; });
            });
            loop();
        }

        function updateLobbyUI() {
            document.getElementById('lobbyHighScore').innerText = Math.floor(highScore);
            document.getElementById('shopHighScore').innerText = Math.floor(highScore);
            const currentSkin = SKINS.find(s => s.id === selectedSkinId) || SKINS[0];
            const preview = document.getElementById('currentSkinPreview');
            if (currentSkin.type === 'color') preview.style.background = currentSkin.value;
            else preview.style.background = `linear-gradient(45deg, ${currentSkin.value.join(', ')})`;
        }

        function renderShop() {
            const grid = document.getElementById('skinsGrid');
            grid.innerHTML = '';
            SKINS.forEach(skin => {
                const locked = highScore < skin.unlock;
                const selected = selectedSkinId === skin.id;
                const card = document.createElement('div');
                card.className = `skin-card bg-gray-800 rounded-lg p-3 flex flex-col items-center cursor-pointer border border-gray-700 ${selected ? 'selected' : ''} ${locked ? 'locked' : ''}`;
                let bgStyle = '';
                if (skin.type === 'color') bgStyle = skin.value;
                else bgStyle = `linear-gradient(45deg, ${skin.value.join(', ')})`;
                let content = `<div class="w-16 h-16 rounded-full mb-2 shadow-inner" style="background: ${bgStyle}"></div><div class="font-bold text-sm">${skin.name}</div>`;
                if (locked) { content += `<div class="text-xs text-red-400 mt-1">Recorde: ${skin.unlock}</div><div class="absolute inset-0 flex items-center justify-center lock-overlay"><span class="text-3xl">🔒</span></div>`; } 
                else if (selected) { content += `<div class="text-xs text-green-400 mt-1">Selecionado</div>`; } 
                else { content += `<div class="text-xs text-gray-500 mt-1">Clique para usar</div>`; }
                card.innerHTML = content;
                if (!locked) { card.onclick = () => selectSkin(skin.id); }
                grid.appendChild(card);
            });
        }

        function selectSkin(id) {
            selectedSkinId = id;
            localStorage.setItem('slither_skin', id);
            renderShop();
            updateLobbyUI();
        }

        async function startGame() {
            const nick = document.getElementById('nickname').value || "Cobrinha";
            playerId = 'player_' + Math.random().toString(36).substr(2, 9);
            playerRef = ref(db, 'players/' + playerId);
            player = new Snake(playerId, rand(-1000, 1000), rand(-1000, 1000), nick, selectedSkinId, true);
            snakes[playerId] = player;
            await set(playerRef, {
                x: Math.round(player.x), y: Math.round(player.y), angle: player.angle,
                mass: player.mass, boosting: false, skinId: selectedSkinId,
                name: nick, dead: false, timestamp: Date.now()
            });
            onDisconnect(playerRef).remove();
            foods = []; particles = [];
            for (let i = 0; i < CONFIG.foodCount; i++) { foods.push(new Food()); }
            gameState = 'PLAYING';
            document.getElementById('lobby').classList.add('hidden');
            document.getElementById('gameOver').classList.add('hidden');
            document.getElementById('hud').classList.remove('hidden');
        }

        function createExplosion(x, y, color, mass) {
            const foodAmount = Math.min(100, Math.max(10, mass / 2)); 
            const scatter = Math.min(150, mass); 
            for(let i=0; i<foodAmount; i++) {
                const fMass = rand(0.5, 2);
                foods.push(new Food(x + rand(-scatter, scatter), y + rand(-scatter, scatter), fMass, typeof color === 'string' ? color : color[0]));
            }
            for(let i=0; i<20; i++) { particles.push(new Particle(x, y, typeof color === 'string' ? color : color[0])); }
        }

        function update() {
            if(!slitherGameActive) return; // Only update if visible
            
            frame++;
            if (gameState === 'PLAYING') {
                while (foods.length < CONFIG.foodCount) foods.push(new Food());
                Object.values(snakes).forEach(snake => snake.update());
                if (player) {
                    let targetScale = Math.max(0.1, 0.9 - (player.width - 20) * 0.003); 
                    camera.scale += (targetScale - camera.scale) * 0.05;
                    camera.x = width / 2 - player.x * camera.scale;
                    camera.y = height / 2 - player.y * camera.scale;
                    document.getElementById('scoreDisplay').innerText = Math.floor(player.mass);
                }
                checkCollisions();
                particles.forEach(p => p.update());
                particles = particles.filter(p => p.life > 0);
                updateLeaderboard();
                drawMinimap();
            }
        }

        function checkCollisions() {
            if (!player || player.dead) return;
            for (let i = foods.length - 1; i >= 0; i--) {
                const f = foods[i];
                if (Math.abs(player.x - f.x) > player.width + f.radius) continue;
                if (Math.abs(player.y - f.y) > player.width + f.radius) continue;
                if (dist(player.x, player.y, f.x, f.y) < player.width / 2 + f.radius) {
                    player.mass += f.mass;
                    foods.splice(i, 1);
                }
            }
            const allSnakes = Object.values(snakes);
            for (let other of allSnakes) {
                if (other === player) continue;
                if (Math.abs(player.x - other.x) > 1000) continue; 
                for (let k = 0; k < other.history.length; k+=2) {
                    const pt = other.history[k];
                    if (dist(player.x, player.y, pt.x, pt.y) < player.width/2 + other.width/2 - 4) {
                        killSnake(player, other.name, true);
                        break;
                    }
                }
            }
        }

        function killSnake(snake, killerName, isLocalDeath) {
            snake.dead = true;
            let explosionColor = snake.skin.type === 'color' ? snake.skin.value : snake.skin.value[0];
            createExplosion(snake.x, snake.y, explosionColor, snake.mass);
            if (isLocalDeath && snake === player) {
                fbUpdate(playerRef, { dead: true });
                if (snake.mass > highScore) {
                    highScore = snake.mass;
                    localStorage.setItem('slither_highscore', highScore);
                    updateLobbyUI();
                }
                setTimeout(() => {
                    remove(playerRef);
                    showGameOver(killerName);
                }, 1000);
            }
        }

        function showGameOver(killer) {
            gameState = 'GAMEOVER';
            document.getElementById('hud').classList.add('hidden');
            document.getElementById('gameOver').classList.remove('hidden');
            document.getElementById('finalScore').innerText = Math.floor(player.mass);
            document.getElementById('killedBy').innerText = killer;
        }

        function draw() {
            if(!slitherGameActive) return; // Only draw if visible
            
            ctx.fillStyle = '#161c22';
            ctx.fillRect(0, 0, width, height);
            ctx.save();
            if (gameState === 'PLAYING' || gameState === 'GAMEOVER') {
                ctx.translate(camera.x, camera.y);
                ctx.scale(camera.scale, camera.scale);
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.04)'; ctx.lineWidth = 2;
                const gridSize = 80;
                const left = -camera.x / camera.scale; const top = -camera.y / camera.scale;
                const right = (width - camera.x) / camera.scale; const bottom = (height - camera.y) / camera.scale;
                ctx.beginPath();
                const startX = Math.floor(left / gridSize) * gridSize;
                const startY = Math.floor(top / gridSize) * gridSize;
                for (let x = startX; x <= right; x += gridSize) { ctx.moveTo(x, top); ctx.lineTo(x, bottom); }
                for (let y = startY; y <= bottom; y += gridSize) { ctx.moveTo(left, y); ctx.lineTo(right, y); }
                ctx.stroke();
                ctx.strokeStyle = '#440000'; ctx.lineWidth = 20;
                ctx.strokeRect(-CONFIG.worldSize, -CONFIG.worldSize, CONFIG.worldSize*2, CONFIG.worldSize*2);
                foods.forEach(f => {
                    if (f.x > left - 100 && f.x < right + 100 && f.y > top - 100 && f.y < bottom + 100) f.draw(ctx);
                });
                particles.forEach(p => p.draw(ctx));
                const snakeList = Object.values(snakes).sort((a, b) => (a === player ? 1 : -1));
                snakeList.forEach(s => s.draw(ctx));
            }
            ctx.restore();
        }

        function drawMinimap() {
            minimapCtx.clearRect(0, 0, 128, 128);
            minimapCtx.fillStyle = 'rgba(0,0,0,0.5)'; minimapCtx.fillRect(0,0,128,128);
            const scale = 128 / (CONFIG.worldSize * 2);
            Object.values(snakes).forEach(s => {
                const mx = (s.x + CONFIG.worldSize) * scale;
                const my = (s.y + CONFIG.worldSize) * scale;
                let mColor = '#FFF';
                if (s !== player) mColor = s.skin.type === 'color' ? s.skin.value : s.skin.value[0];
                minimapCtx.fillStyle = s === player ? '#FFF' : mColor;
                minimapCtx.beginPath(); minimapCtx.arc(mx, my, s === player ? 3 : 2, 0, Math.PI * 2); minimapCtx.fill();
            });
        }

        function updateLeaderboard() {
            if (frame % 30 !== 0) return;
            const list = document.getElementById('leaderboard');
            list.innerHTML = '';
            const sorted = Object.values(snakes).sort((a, b) => b.mass - a.mass).slice(0, 10);
            sorted.forEach((s, i) => {
                const li = document.createElement('li');
                li.className = 'flex justify-between';
                if (s === player) li.className += ' text-green-400 font-bold';
                li.innerHTML = `<span>${i+1}. ${s.name.substring(0,10)}</span> <span>${Math.floor(s.mass)}</span>`;
                list.appendChild(li);
            });
        }

        function loop() {
            update();
            draw();
            requestAnimationFrame(loop);
        }

        function resize() {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
        }

        // Shop Events
        document.getElementById('openShopBtn').addEventListener('click', () => {
            document.getElementById('lobby').classList.add('opacity-0');
            setTimeout(() => {
                document.getElementById('lobby').classList.add('hidden');
                document.getElementById('skinShop').classList.remove('hidden');
                document.getElementById('lobby').classList.remove('opacity-0');
                renderShop();
            }, 300);
        });
        document.getElementById('closeShopBtn').addEventListener('click', () => {
            document.getElementById('skinShop').classList.add('hidden');
            document.getElementById('lobby').classList.remove('hidden');
        });

        // Input Handling
        window.addEventListener('mousemove', e => { mouse.x = e.clientX; mouse.y = e.clientY; });
        window.addEventListener('mousedown', () => mouse.active = true);
        window.addEventListener('mouseup', () => mouse.active = false);
        window.addEventListener('keydown', e => { if (e.code === 'Space') boostKey = true; });
        window.addEventListener('keyup', e => { if (e.code === 'Space') boostKey = false; });
        document.getElementById('playBtn').addEventListener('click', startGame);
        document.getElementById('restartBtn').addEventListener('click', () => {
            document.getElementById('gameOver').classList.add('hidden');
            document.getElementById('lobby').classList.remove('hidden');
            gameState = 'LOBBY';
            updateLobbyUI();
        });

        function initMobileControls() {
            if ('ontouchstart' in window || navigator.maxTouchPoints > 0) {
                isMobile = true;
                document.getElementById('mobileControls').classList.remove('hidden');
            }
            const joyZone = document.getElementById('joystickZone');
            const joyKnob = document.getElementById('joystickKnob');
            const boostBtn = document.getElementById('mobileBoostBtn');
            let joyCenter = { x: 0, y: 0 };
            const maxDist = 35; 
            joyZone.addEventListener('touchstart', (e) => {
                e.preventDefault(); joystick.active = true;
                const rect = joyZone.getBoundingClientRect();
                joyCenter = { x: rect.left + rect.width/2, y: rect.top + rect.height/2 };
                updateJoystick(e.touches[0]);
            }, { passive: false });
            joyZone.addEventListener('touchmove', (e) => {
                e.preventDefault();
                for (let i = 0; i < e.touches.length; i++) {
                    const touch = e.touches[i];
                    const distToCenter = Math.hypot(touch.clientX - joyCenter.x, touch.clientY - joyCenter.y);
                    if (distToCenter < 100) { updateJoystick(touch); break; }
                }
            }, { passive: false });
            const endJoystick = (e) => {
                e.preventDefault(); joystick.active = false;
                joyKnob.style.transform = `translate(0px, 0px)`;
            };
            joyZone.addEventListener('touchend', endJoystick);
            joyZone.addEventListener('touchcancel', endJoystick);
            function updateJoystick(touch) {
                let dx = touch.clientX - joyCenter.x;
                let dy = touch.clientY - joyCenter.y;
                const angle = Math.atan2(dy, dx);
                const dist = Math.min(Math.hypot(dx, dy), maxDist);
                const kx = Math.cos(angle) * dist;
                const ky = Math.sin(angle) * dist;
                joyKnob.style.transform = `translate(${kx}px, ${ky}px)`;
                joystick.angle = angle;
            }
            boostBtn.addEventListener('touchstart', (e) => {
                e.preventDefault(); mouse.active = true;
                boostBtn.classList.add('scale-90');
            }, { passive: false });
            boostBtn.addEventListener('touchend', (e) => {
                e.preventDefault(); mouse.active = false;
                boostBtn.classList.remove('scale-90');
            });
        }
        initMobileControls();
        init();

    </script>
</body>
</html>
